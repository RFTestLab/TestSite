<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Credit Card Test (with iframe controls & log)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --brand-green: #00A859; --bg: #f7fbf7; }
    body { background:var(--bg); padding-bottom: 260px; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .home-btn { position: fixed; top: 12px; left: 12px; z-index: 1300; }

    /* panel button */
    #panelToggle {
      position: fixed;
      top: 12px; right: 12px;
      z-index: 1300;
      display: inline-flex;
      align-items: center; justify-content: center;
      width: 44px; height: 44px;
      border-radius: 999px;
      background: var(--brand-green); color: #fff; border: none;
      box-shadow: 0 4px 10px rgba(0,0,0,.15);
      cursor: pointer;
    }
    #panelToggle:active { transform: translateY(1px); }

    /* Floating  panel  */
    .controls {
      position: fixed;
      right: 12px;
      top: 64px; 
      width: min(380px, 92vw);
      max-height: 70vh;
      overflow: auto;
      background: #fff;
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 12px 28px rgba(0,0,0,0.12);
      z-index: 1200;
      transition: transform .25s ease;
    }
    .controls-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }

   
    .controls.hidden-global {
      transform: translateX(calc(100% + 24px));
    }

   
    @media (max-width: 767.98px) {
      .controls {
        left: 12px; right: 12px;
        width: auto;
        top: auto; bottom: 64px;
        max-height: 55vh;
        border-radius: 12px;
        transform: translateY(0);
      }
      
      .controls.hidden-global {
        transform: translateY(calc(100% + 24px));
      }
    }

    .frame-box { min-height: 420px; border: 1px solid #e6efe8; border-radius: 8px; overflow: hidden; background: white; }
    #log { position: fixed; left: 0; right: 0; bottom: 0; height: 240px; background: #0b1220; color: #dbeafe; padding: 12px; overflow:auto; font-family: monospace; font-size: 13px; z-index: 1100; }
    .log-line { margin-bottom:6px; }
    .vis-mode { display:inline-block; margin-right: 12px; }
    .sandbox-list { display:flex; gap:8px; flex-wrap:wrap; }
    .muted-small { font-size: .85rem; color:#6b7280; }
    .form-card { background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.04); }
    .btn-brand { background: var(--brand-green); color: #fff; border: none; }
  </style>
</head>
<body>
  <a class="btn btn-sm btn-outline-secondary home-btn" href="index.html">Home</a>

  <!-- Panel button  -->
  <button id="panelToggle" title="Toggle control panel">â˜°</button>

  <!-- Floating control panel -->
  <div class="controls" id="controlsPanel">
    <div class="controls-header">
      <h6 class="mb-0">Iframe controls & logging</h6>
      <span class="badge text-bg-light" id="panelStatus">idle</span>
    </div>

    <div class="mb-2">
      <label class="form-label">Sandbox attributes</label>
      <div class="sandbox-list">
        <div><input type="checkbox" id="sb-allow-forms"> <label for="sb-allow-forms">allow-forms</label></div>
        <div><input type="checkbox" id="sb-allow-scripts"> <label for="sb-allow-scripts">allow-scripts</label></div>
        <div><input type="checkbox" id="sb-allow-same-origin"> <label for="sb-allow-same-origin">allow-same-origin</label></div>
        <div><input type="checkbox" id="sb-allow-popups"> <label for="sb-allow-popups">allow-popups</label></div>
      </div>
    </div>

    <div class="mb-2">
      <label class="form-label">Visibility mode</label>
      <div>
        <label class="vis-mode"><input type="radio" name="vis" value="normal" checked> Normal</label>
        <label class="vis-mode"><input type="radio" name="vis" value="display-none"> display:none</label>
        <label class="vis-mode"><input type="radio" name="vis" value="opacity-zero"> opacity:0</label>
        <label class="vis-mode"><input type="radio" name="vis" value="offscreen"> off-screen</label>
        <label class="vis-mode"><input type="radio" name="vis" value="zero-size"> 0x0</label>
      </div>
    </div>

    <div class="mb-2 d-flex gap-2 flex-wrap">
      <button id="applyBtn" class="btn btn-sm btn-primary">Apply</button>
      <button id="reloadBtn" class="btn btn-sm btn-secondary">Reload iframe</button>
      <button id="pingBtn" class="btn btn-sm btn-outline-secondary">Ping iframe</button>
      <button id="snapshotBtn" class="btn btn-sm btn-info">Snapshot</button>
    </div>

    <div class="mb-2">
      <small class="muted-small">Iframe URL: <strong id="iframeUrl">https://rftestlab.github.io/EvilSite/cc</strong></small>
    </div>

    <hr/>
    <div>
      <h6 class="mb-1">Quick actions</h6>
      <button id="fillLocalBtn" class="btn btn-sm btn-success">Fill local form (simulate)</button>
      <button id="clearLogBtn" class="btn btn-sm btn-warning">Clear log</button>
    </div>
  </div>

  <!-- Page content -->
  <div class="container pt-5">
    <div class="row g-4">
      <div class="col-lg-4">
        <div class="form-card">
          <h5>Local Credit Card Form (parent)</h5>
          <form id="local-cc-form" autocomplete="on">
            <div class="mb-2">
              <label for="cc-name" class="form-label">Cardholder name</label>
              <input autocomplete="cc-name" id="cc-name" class="form-control" placeholder="JOHN DOE">
            </div>
            <div class="mb-2">
              <label for="cc-number" class="form-label">Card number</label>
              <input autocomplete="cc-number" id="cc-number" class="form-control" placeholder="4242 4242 4242 4242" inputmode="numeric">
            </div>
            <div class="row">
              <div class="col-6 mb-2">
                <label for="cc-exp" class="form-label">Expiry</label>
                <input autocomplete="cc-exp" id="cc-exp" class="form-control" placeholder="MM/YY">
              </div>
              <div class="col-6 mb-2">
                <label for="cc-csc" class="form-label">CVC</label>
                <input autocomplete="cc-csc" id="cc-csc" class="form-control" placeholder="123" inputmode="numeric">
              </div>
            </div>
            <button href="succes.html" type="submit" class="btn btn-brand">Save card</button>
          </form>
        </div>
      </div>

      <div class="col-lg-8">
        <div id="frameContainer" class="frame-box">
          <iframe id="evil-iframe"
                  src="https://rftestlab.github.io/EvilSite/cc"
                  title="Evil cc embed"
                  width="100%" height="100%"
                  style="border:0; min-height:420px;"
                  sandbox="">
          </iframe>
        </div>
      </div>
    </div>
  </div>

  <div id="log"></div>

  <script>
    (function(){
      const iframe = document.getElementById('evil-iframe');
      const logEl = document.getElementById('log');
      const panel = document.getElementById('controlsPanel');
      const toggleBtn = document.getElementById('panelToggle');
      const panelStatus = document.getElementById('panelStatus');

      function log(msg, tag='INFO') {
        const time = new Date().toLocaleTimeString();
        const line = document.createElement('div');
        line.className = 'log-line';
        line.textContent = `[${time}] ${tag}: ${msg}`;
        logEl.appendChild(line);
        logEl.scrollTop = logEl.scrollHeight;
      }
      function setStatus(s){ panelStatus.textContent = s; }

      // Global toggle 
      function togglePanel(){
        const hidden = panel.classList.toggle('hidden-global');
        toggleBtn.setAttribute('aria-pressed', String(!hidden));
        toggleBtn.title = hidden ? 'Show controls' : 'Hide controls';
      }
      toggleBtn.addEventListener('click', togglePanel);

      // postMessage from iframe
      window.addEventListener('message', (ev) => {
        const data = ev.data || {};
        if (data && data.source === 'EvilSite') {
          const evt = data.event || 'unknown';
          if (evt === 'EVIL_READY') {
            log('Evil iframe ready: ' + JSON.stringify(data.payload), 'IFRAME');
            setStatus('ready');
          } else if (evt === 'FORM_SNAPSHOT') {
            log('Iframe snapshot: ' + JSON.stringify(data.payload && data.payload.data), 'IFRAME');
            setStatus('snapshot');
          } else if (evt === 'FIELD_CHANGED') {
            log(`Iframe field changed: ${data.payload?.name} = "${data.payload?.value}"`, 'IFRAME');
          } else if (evt === 'FORM_SUBMIT') {
            log('Iframe form submit: ' + JSON.stringify(data.payload), 'IFRAME');
          } else {
            log('Iframe event ' + evt + ': ' + JSON.stringify(data.payload), 'IFRAME');
          }
          return;
        }
        log(`Message from iframe (${ev.origin}): ${JSON.stringify(ev.data)}`, 'IFRAME');
      });

      // local form logging
      const localForm = document.getElementById('local-cc-form');
      ['input','change'].forEach(evName => {
        localForm.addEventListener(evName, (e) => {
          log(`Local CC form change: ${e.target.id} = "${e.target.value}"`);
        });
      });

      // sandbox handling
      function buildSandbox() {
        const parts = [];
        if (document.getElementById('sb-allow-forms').checked) parts.push('allow-forms');
        if (document.getElementById('sb-allow-scripts').checked) parts.push('allow-scripts');
        if (document.getElementById('sb-allow-same-origin').checked) parts.push('allow-same-origin');
        if (document.getElementById('sb-allow-popups').checked) parts.push('allow-popups');
        return parts.join(' ');
      }

      function applyControls() {
        const sand = buildSandbox();
        if (sand.trim().length === 0) {
          iframe.removeAttribute('sandbox'); // no sandbox atribut
          log('Applied sandbox: (none) - iframe has NO sandbox attribute');
        } else {
          iframe.setAttribute('sandbox', sand);
          log('Applied sandbox: ' + sand);
        }

        // visibility:
        const vis = document.querySelector('input[name="vis"]:checked').value;
        Object.assign(iframe.style, {
          display:'', opacity:'', position:'', left:'', top:'', width:'', height:'', visibility:'', transform:'', pointerEvents:'', border:''
        });

        if (vis === 'display-none') {
          iframe.style.display = 'none';
          log('Visibility: display:none');
        } else if (vis === 'opacity-zero') {
          iframe.style.opacity = '0';
          iframe.style.pointerEvents = 'none';
          log('Visibility: opacity:0 (invisible, still in layout)');
        } else if (vis === 'offscreen') {
          iframe.style.position = 'absolute';
          iframe.style.left = '-2000px';
          iframe.style.top = '-2000px';
          iframe.style.width = '600px';
          iframe.style.height = '400px';
          log('Visibility: off-screen');
        } else if (vis === 'zero-size') {
          iframe.style.width = '0px';
          iframe.style.height = '0px';
          iframe.style.border = '0';
          log('Visibility: zero-size (0x0)');
        } else {
          log('Visibility: normal');
        }
      }

      document.getElementById('applyBtn').addEventListener('click', applyControls);
      document.getElementById('reloadBtn').addEventListener('click', () => {
        const src = iframe.getAttribute('src'); iframe.setAttribute('src', src);
        log('Reloaded iframe');
      });
      document.getElementById('pingBtn').addEventListener('click', () => {
        try {
          iframe.contentWindow.postMessage({ type: 'PING_PARENT', ts: Date.now() }, '*');
          log('Posted PING_PARENT to iframe');
        } catch(e){ log('Failed to postMessage: ' + e, 'ERROR'); }
      });
      document.getElementById('snapshotBtn').addEventListener('click', () => {
        try {
          iframe.contentWindow.postMessage({ type: 'REQUEST_SNAPSHOT', ts: Date.now() }, '*');
          log('Requested snapshot from iframe');
        } catch(e){ log('Snapshot request failed: ' + e, 'ERROR'); }
      });

      // quick fill local simulation
      document.getElementById('fillLocalBtn').addEventListener('click', () => {
        document.getElementById('cc-name').value = 'Alice Example';
        document.getElementById('cc-number').value = '4242424242424242';
        document.getElementById('cc-exp').value = '12/34';
        document.getElementById('cc-csc').value = '123';
        log('Local CC form prefilled programmatically');
      });

      document.getElementById('clearLogBtn').addEventListener('click', () => {
        logEl.innerHTML = '';
      });

      // detect iframe load
      iframe.addEventListener('load', () => {
        log(`Iframe loaded (src=${iframe.src})`, 'IFRAME');
        try {
          iframe.contentWindow.postMessage({ type: 'PING_PARENT', ts: Date.now() }, '*');
        } catch (e) {
          log('Failed to postMessage to iframe: ' + e, 'ERROR');
        }
      });

      // submit handler local
      localForm.addEventListener('submit', (e) => {
        e.preventDefault();
        log('Local CC form submitted');
      });

      log('Control panel ready. Waiting for iframe messages...');
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
