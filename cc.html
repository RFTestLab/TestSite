<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Credit Card Test (with iframe controls & log)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root { --brand-green: #00A859; --bg: #f7fbf7; }
    body { background:var(--bg); padding-bottom: 260px; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
    .home-btn { position: fixed; top: 12px; left: 12px; z-index: 999; }
    .controls { position: sticky; top: 12px; background: #fff; padding: 12px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.06); }
    .frame-box { min-height: 420px; border: 1px solid #e6efe8; border-radius: 8px; overflow: hidden; background: white; }
    #log { position: fixed; left: 0; right: 0; bottom: 0; height: 240px; background: #0b1220; color: #dbeafe; padding: 12px; overflow:auto; font-family: monospace; font-size: 13px;}
    .log-line { margin-bottom:6px; }
    .vis-mode { display:inline-block; margin-right: 12px; }
    .sandbox-list { display:flex; gap:8px; flex-wrap:wrap; }
    .muted-small { font-size: .85rem; color:#6b7280; }
    .form-card { background: #fff; border-radius: 8px; padding: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.04); }
    label.small-muted { font-size: .85rem; color:#6b7280; }
    .btn-brand { background: var(--brand-green); color: #fff; border: none; }
    @media (max-width: 767px) {
      .controls { margin-bottom: 12px; }
    }
  </style>
</head>
<body>
  <a class="btn btn-sm btn-outline-secondary home-btn" href="index.html">Home</a>

  <div class="container pt-5">
    <div class="row g-4">
      <div class="col-lg-4">
        <div class="controls">
          <h6>Iframe controls & logging</h6>

          <div class="mb-2">
            <label class="form-label">Sandbox attributes</label>
            <div class="sandbox-list">
              <div><input type="checkbox" id="sb-allow-forms"> <label for="sb-allow-forms">allow-forms</label></div>
              <div><input type="checkbox" id="sb-allow-scripts"> <label for="sb-allow-scripts">allow-scripts</label></div>
              <div><input type="checkbox" id="sb-allow-same-origin"> <label for="sb-allow-same-origin">allow-same-origin</label></div>
              <div><input type="checkbox" id="sb-allow-popups"> <label for="sb-allow-popups">allow-popups</label></div>
            </div>
          </div>

          <div class="mb-2">
            <label class="form-label">Visibility mode</label>
            <div>
              <label class="vis-mode"><input type="radio" name="vis" value="normal" checked> Normal</label>
              <label class="vis-mode"><input type="radio" name="vis" value="display-none"> display:none</label>
              <label class="vis-mode"><input type="radio" name="vis" value="opacity-zero"> opacity:0</label>
              <label class="vis-mode"><input type="radio" name="vis" value="offscreen"> off-screen</label>
              <label class="vis-mode"><input type="radio" name="vis" value="zero-size"> 0x0</label>
            </div>
          </div>

          <div class="mb-2">
            <button id="applyBtn" class="btn btn-sm btn-primary">Apply</button>
            <button id="reloadBtn" class="btn btn-sm btn-secondary">Reload iframe</button>
          </div>

          <div class="mb-2">
            <small class="muted-small">Iframe URL: <strong id="iframeUrl">https://rftestlab.github.io/EvilSite/cc</strong></small>
          </div>

          <hr/>
          <div>
            <h6 class="mb-1">Quick actions</h6>
            <button id="fillLocalBtn" class="btn btn-sm btn-success">Fill local form (simulate)</button>
            <button id="clearLogBtn" class="btn btn-sm btn-warning">Clear log</button>
          </div>

        </div>

        <div class="mt-3 form-card">
          <h5>Local Credit Card Form (parent)</h5>
          <form id="local-cc-form" autocomplete="on">
            <div class="mb-2">
              <label for="cc-name" class="form-label">Cardholder name</label>
              <input autocomplete="cc-name" id="cc-name" class="form-control" placeholder="JOHN DOE">
            </div>
            <div class="mb-2">
              <label for="cc-number" class="form-label">Card number</label>
              <input autocomplete="cc-number" id="cc-number" class="form-control" placeholder="4242 4242 4242 4242" inputmode="numeric">
            </div>
            <div class="row">
              <div class="col-6 mb-2">
                <label for="cc-exp" class="form-label">Expiry</label>
                <input autocomplete="cc-exp" id="cc-exp" class="form-control" placeholder="MM/YY">
              </div>
              <div class="col-6 mb-2">
                <label for="cc-csc" class="form-label">CVC</label>
                <input autocomplete="cc-csc" id="cc-csc" class="form-control" placeholder="123" inputmode="numeric">
              </div>
            </div>
            <button type="submit" class="btn btn-brand">Save card</button>
          </form>
        </div>

      </div>

      <div class="col-lg-8">
        <div id="frameContainer" class="frame-box">
          <iframe id="evil-iframe"
                  src="https://rftestlab.github.io/EvilSite/cc"
                  title="Evil cc embed"
                  width="100%" height="100%"
                  style="border:0; min-height:420px;"
                  sandbox="">
          </iframe>
        </div>
      </div>
    </div>
  </div>

  <div id="log"></div>

  <script>
    (function(){
      const iframe = document.getElementById('evil-iframe');
      const logEl = document.getElementById('log');

      function log(msg, tag='INFO') {
        const time = new Date().toLocaleTimeString();
        const line = document.createElement('div');
        line.className = 'log-line';
        line.textContent = `[${time}] ${tag}: ${msg}`;
        logEl.appendChild(line);
        logEl.scrollTop = logEl.scrollHeight;
      }

      // Listen to messages from iframe (EvilSite must postMessage)
      window.addEventListener('message', (ev) => {
        // optional: validate ev.origin if you want to filter
        log(`Message from iframe (${ev.origin}): ${JSON.stringify(ev.data)}`, 'IFRAME');
      });

      // local form changes -> log them
      const localForm = document.getElementById('local-cc-form');
      ['input','change'].forEach(evName => {
        localForm.addEventListener(evName, (e) => {
          log(`Local form change: ${e.target.id} = "${e.target.value}"`);
        });
      });

      // sandbox handling
      function buildSandbox() {
        const parts = [];
        if (document.getElementById('sb-allow-forms').checked) parts.push('allow-forms');
        if (document.getElementById('sb-allow-scripts').checked) parts.push('allow-scripts');
        if (document.getElementById('sb-allow-same-origin').checked) parts.push('allow-same-origin');
        if (document.getElementById('sb-allow-popups').checked) parts.push('allow-popups');
        return parts.join(' ');
      }

      function applyControls() {
        const sand = buildSandbox();
        if (sand.trim().length === 0) {
          iframe.removeAttribute('sandbox'); // fully sandboxless (no attribute)
          log('Applied sandbox: (none) - iframe has NO sandbox attribute');
        } else {
          iframe.setAttribute('sandbox', sand);
          log('Applied sandbox: ' + sand);
        }

        // visibility:
        const vis = document.querySelector('input[name="vis"]:checked').value;
        const container = document.getElementById('frameContainer');
        // reset styles
        iframe.style.display = '';
        iframe.style.opacity = '';
        iframe.style.position = '';
        iframe.style.left = '';
        iframe.style.top = '';
        iframe.style.width = '';
        iframe.style.height = '';
        iframe.style.visibility = '';
        iframe.style.transform = '';

        if (vis === 'display-none') {
          iframe.style.display = 'none';
          log('Visibility: display:none (iframe removed from render flow)');
        } else if (vis === 'opacity-zero') {
          iframe.style.opacity = '0';
          log('Visibility: opacity:0 (still in layout, invisible)');
        } else if (vis === 'offscreen') {
          iframe.style.position = 'absolute';
          iframe.style.left = '-2000px';
          iframe.style.top = '-2000px';
          iframe.style.width = '600px';
          iframe.style.height = '400px';
          log('Visibility: off-screen (positioned outside viewport)');
        } else if (vis === 'zero-size') {
          iframe.style.width = '0px';
          iframe.style.height = '0px';
          iframe.style.border = '0';
          log('Visibility: zero-size (0x0)');
        } else {
          log('Visibility: normal');
        }
      }

      document.getElementById('applyBtn').addEventListener('click', () => applyControls());
      document.getElementById('reloadBtn').addEventListener('click', () => {
        // reload by resetting src (more robust for cross-origin reloads)
        const src = iframe.getAttribute('src');
        iframe.setAttribute('src', src);
        log('Reloaded iframe');
      });

      // quick fill local simulation
      document.getElementById('fillLocalBtn').addEventListener('click', () => {
        document.getElementById('cc-name').value = 'Alice Example';
        document.getElementById('cc-number').value = '4242424242424242';
        document.getElementById('cc-exp').value = '12/34';
        document.getElementById('cc-csc').value = '123';
        log('Local CC form prefilled programmatically');
      });

      document.getElementById('clearLogBtn').addEventListener('click', () => {
        logEl.innerHTML = '';
      });

      // detect iframe load
      iframe.addEventListener('load', () => {
        log(`Iframe loaded (src=${iframe.src})`, 'IFRAME');
        // handshake ping to iframe (if it listens)
        try {
          iframe.contentWindow.postMessage({ type: 'PING_PARENT', ts: Date.now() }, '*');
        } catch (e) {
          log('Failed to postMessage to iframe: ' + e, 'ERROR');
        }
      });

      // submit handler local
      localForm.addEventListener('submit', (e) => {
        e.preventDefault();
        log('Local CC form submitted');
      });

      // initialization log
      log('Control panel ready. Waiting for iframe messages...');
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
